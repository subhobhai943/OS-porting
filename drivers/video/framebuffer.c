/**
 * AAAos Kernel - Framebuffer Graphics Driver Implementation
 *
 * Provides pixel-level graphics operations for VESA/GOP framebuffers.
 */

#include "framebuffer.h"
#include "../../kernel/include/serial.h"

/* Global framebuffer state */
static framebuffer_t fb_info = {
    .address = NULL,
    .width = 0,
    .height = 0,
    .pitch = 0,
    .bpp = 0,
    .size = 0,
    .initialized = false
};

/**
 * Basic 8x16 bitmap font (ASCII 32-126)
 * Each character is 8 pixels wide and 16 pixels tall.
 * Each row is stored as a single byte (8 bits = 8 pixels).
 */
static const uint8_t font_8x16[95][16] = {
    /* Space (32) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* ! (33) */
    { 0x00, 0x00, 0x18, 0x3C, 0x3C, 0x3C, 0x18, 0x18,
      0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00 },
    /* " (34) */
    { 0x00, 0x66, 0x66, 0x66, 0x24, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* # (35) */
    { 0x00, 0x00, 0x00, 0x6C, 0x6C, 0xFE, 0x6C, 0x6C,
      0x6C, 0xFE, 0x6C, 0x6C, 0x00, 0x00, 0x00, 0x00 },
    /* $ (36) */
    { 0x00, 0x10, 0x10, 0x7C, 0xD6, 0xD0, 0x7C, 0x16,
      0xD6, 0x7C, 0x10, 0x10, 0x00, 0x00, 0x00, 0x00 },
    /* % (37) */
    { 0x00, 0x00, 0x00, 0x00, 0xC2, 0xC6, 0x0C, 0x18,
      0x30, 0x60, 0xC6, 0x86, 0x00, 0x00, 0x00, 0x00 },
    /* & (38) */
    { 0x00, 0x00, 0x38, 0x6C, 0x6C, 0x38, 0x76, 0xDC,
      0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 },
    /* ' (39) */
    { 0x00, 0x30, 0x30, 0x30, 0x60, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* ( (40) */
    { 0x00, 0x00, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x30,
      0x30, 0x30, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00 },
    /* ) (41) */
    { 0x00, 0x00, 0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x0C,
      0x0C, 0x0C, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00 },
    /* * (42) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x3C, 0xFF,
      0x3C, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* + (43) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x7E,
      0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* , (44) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x18, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00 },
    /* - (45) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* . (46) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00 },
    /* / (47) */
    { 0x00, 0x00, 0x00, 0x00, 0x02, 0x06, 0x0C, 0x18,
      0x30, 0x60, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00 },
    /* 0 (48) */
    { 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xCE, 0xDE, 0xF6,
      0xE6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* 1 (49) */
    { 0x00, 0x00, 0x18, 0x38, 0x78, 0x18, 0x18, 0x18,
      0x18, 0x18, 0x18, 0x7E, 0x00, 0x00, 0x00, 0x00 },
    /* 2 (50) */
    { 0x00, 0x00, 0x7C, 0xC6, 0x06, 0x0C, 0x18, 0x30,
      0x60, 0xC0, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00 },
    /* 3 (51) */
    { 0x00, 0x00, 0x7C, 0xC6, 0x06, 0x06, 0x3C, 0x06,
      0x06, 0x06, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* 4 (52) */
    { 0x00, 0x00, 0x0C, 0x1C, 0x3C, 0x6C, 0xCC, 0xFE,
      0x0C, 0x0C, 0x0C, 0x1E, 0x00, 0x00, 0x00, 0x00 },
    /* 5 (53) */
    { 0x00, 0x00, 0xFE, 0xC0, 0xC0, 0xC0, 0xFC, 0x06,
      0x06, 0x06, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* 6 (54) */
    { 0x00, 0x00, 0x38, 0x60, 0xC0, 0xC0, 0xFC, 0xC6,
      0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* 7 (55) */
    { 0x00, 0x00, 0xFE, 0xC6, 0x06, 0x06, 0x0C, 0x18,
      0x30, 0x30, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00 },
    /* 8 (56) */
    { 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0x7C, 0xC6,
      0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* 9 (57) */
    { 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0x7E, 0x06,
      0x06, 0x06, 0x0C, 0x78, 0x00, 0x00, 0x00, 0x00 },
    /* : (58) */
    { 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00,
      0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* ; (59) */
    { 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00,
      0x00, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00 },
    /* < (60) */
    { 0x00, 0x00, 0x00, 0x06, 0x0C, 0x18, 0x30, 0x60,
      0x30, 0x18, 0x0C, 0x06, 0x00, 0x00, 0x00, 0x00 },
    /* = (61) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00,
      0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* > (62) */
    { 0x00, 0x00, 0x00, 0x60, 0x30, 0x18, 0x0C, 0x06,
      0x0C, 0x18, 0x30, 0x60, 0x00, 0x00, 0x00, 0x00 },
    /* ? (63) */
    { 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0x0C, 0x18, 0x18,
      0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00 },
    /* @ (64) */
    { 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xDE, 0xDE,
      0xDE, 0xDC, 0xC0, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* A (65) */
    { 0x00, 0x00, 0x10, 0x38, 0x6C, 0xC6, 0xC6, 0xFE,
      0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00 },
    /* B (66) */
    { 0x00, 0x00, 0xFC, 0x66, 0x66, 0x66, 0x7C, 0x66,
      0x66, 0x66, 0x66, 0xFC, 0x00, 0x00, 0x00, 0x00 },
    /* C (67) */
    { 0x00, 0x00, 0x3C, 0x66, 0xC2, 0xC0, 0xC0, 0xC0,
      0xC0, 0xC2, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00 },
    /* D (68) */
    { 0x00, 0x00, 0xF8, 0x6C, 0x66, 0x66, 0x66, 0x66,
      0x66, 0x66, 0x6C, 0xF8, 0x00, 0x00, 0x00, 0x00 },
    /* E (69) */
    { 0x00, 0x00, 0xFE, 0x66, 0x62, 0x68, 0x78, 0x68,
      0x60, 0x62, 0x66, 0xFE, 0x00, 0x00, 0x00, 0x00 },
    /* F (70) */
    { 0x00, 0x00, 0xFE, 0x66, 0x62, 0x68, 0x78, 0x68,
      0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00 },
    /* G (71) */
    { 0x00, 0x00, 0x3C, 0x66, 0xC2, 0xC0, 0xC0, 0xDE,
      0xC6, 0xC6, 0x66, 0x3A, 0x00, 0x00, 0x00, 0x00 },
    /* H (72) */
    { 0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xFE, 0xC6,
      0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00 },
    /* I (73) */
    { 0x00, 0x00, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x18,
      0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 },
    /* J (74) */
    { 0x00, 0x00, 0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C,
      0xCC, 0xCC, 0xCC, 0x78, 0x00, 0x00, 0x00, 0x00 },
    /* K (75) */
    { 0x00, 0x00, 0xE6, 0x66, 0x66, 0x6C, 0x78, 0x78,
      0x6C, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00 },
    /* L (76) */
    { 0x00, 0x00, 0xF0, 0x60, 0x60, 0x60, 0x60, 0x60,
      0x60, 0x62, 0x66, 0xFE, 0x00, 0x00, 0x00, 0x00 },
    /* M (77) */
    { 0x00, 0x00, 0xC6, 0xEE, 0xFE, 0xFE, 0xD6, 0xC6,
      0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00 },
    /* N (78) */
    { 0x00, 0x00, 0xC6, 0xE6, 0xF6, 0xFE, 0xDE, 0xCE,
      0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00 },
    /* O (79) */
    { 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
      0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* P (80) */
    { 0x00, 0x00, 0xFC, 0x66, 0x66, 0x66, 0x7C, 0x60,
      0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00 },
    /* Q (81) */
    { 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
      0xC6, 0xD6, 0xDE, 0x7C, 0x0C, 0x0E, 0x00, 0x00 },
    /* R (82) */
    { 0x00, 0x00, 0xFC, 0x66, 0x66, 0x66, 0x7C, 0x6C,
      0x66, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00 },
    /* S (83) */
    { 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0x60, 0x38, 0x0C,
      0x06, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* T (84) */
    { 0x00, 0x00, 0xFF, 0xDB, 0x99, 0x18, 0x18, 0x18,
      0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 },
    /* U (85) */
    { 0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
      0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* V (86) */
    { 0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
      0xC6, 0x6C, 0x38, 0x10, 0x00, 0x00, 0x00, 0x00 },
    /* W (87) */
    { 0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xD6, 0xD6,
      0xD6, 0xFE, 0xEE, 0x6C, 0x00, 0x00, 0x00, 0x00 },
    /* X (88) */
    { 0x00, 0x00, 0xC6, 0xC6, 0x6C, 0x7C, 0x38, 0x38,
      0x7C, 0x6C, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00 },
    /* Y (89) */
    { 0x00, 0x00, 0xC3, 0xC3, 0xC3, 0x66, 0x3C, 0x18,
      0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 },
    /* Z (90) */
    { 0x00, 0x00, 0xFE, 0xC6, 0x86, 0x0C, 0x18, 0x30,
      0x60, 0xC2, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00 },
    /* [ (91) */
    { 0x00, 0x00, 0x3C, 0x30, 0x30, 0x30, 0x30, 0x30,
      0x30, 0x30, 0x30, 0x3C, 0x00, 0x00, 0x00, 0x00 },
    /* \ (92) */
    { 0x00, 0x00, 0x00, 0x80, 0xC0, 0x60, 0x30, 0x18,
      0x0C, 0x06, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* ] (93) */
    { 0x00, 0x00, 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C,
      0x0C, 0x0C, 0x0C, 0x3C, 0x00, 0x00, 0x00, 0x00 },
    /* ^ (94) */
    { 0x10, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* _ (95) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00 },
    /* ` (96) */
    { 0x00, 0x30, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* a (97) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x0C, 0x7C,
      0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 },
    /* b (98) */
    { 0x00, 0x00, 0xE0, 0x60, 0x60, 0x78, 0x6C, 0x66,
      0x66, 0x66, 0x66, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* c (99) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC0,
      0xC0, 0xC0, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* d (100) */
    { 0x00, 0x00, 0x1C, 0x0C, 0x0C, 0x3C, 0x6C, 0xCC,
      0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 },
    /* e (101) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xFE,
      0xC0, 0xC0, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* f (102) */
    { 0x00, 0x00, 0x1C, 0x36, 0x32, 0x30, 0x78, 0x30,
      0x30, 0x30, 0x30, 0x78, 0x00, 0x00, 0x00, 0x00 },
    /* g (103) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0xCC, 0xCC,
      0xCC, 0xCC, 0xCC, 0x7C, 0x0C, 0xCC, 0x78, 0x00 },
    /* h (104) */
    { 0x00, 0x00, 0xE0, 0x60, 0x60, 0x6C, 0x76, 0x66,
      0x66, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00 },
    /* i (105) */
    { 0x00, 0x00, 0x18, 0x18, 0x00, 0x38, 0x18, 0x18,
      0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 },
    /* j (106) */
    { 0x00, 0x00, 0x06, 0x06, 0x00, 0x0E, 0x06, 0x06,
      0x06, 0x06, 0x06, 0x06, 0x66, 0x66, 0x3C, 0x00 },
    /* k (107) */
    { 0x00, 0x00, 0xE0, 0x60, 0x60, 0x66, 0x6C, 0x78,
      0x78, 0x6C, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00 },
    /* l (108) */
    { 0x00, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18,
      0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 },
    /* m (109) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0xEC, 0xFE, 0xD6,
      0xD6, 0xD6, 0xD6, 0xC6, 0x00, 0x00, 0x00, 0x00 },
    /* n (110) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0xDC, 0x66, 0x66,
      0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00 },
    /* o (111) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC6,
      0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* p (112) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0xDC, 0x66, 0x66,
      0x66, 0x66, 0x66, 0x7C, 0x60, 0x60, 0xF0, 0x00 },
    /* q (113) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0xCC, 0xCC,
      0xCC, 0xCC, 0xCC, 0x7C, 0x0C, 0x0C, 0x1E, 0x00 },
    /* r (114) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0xDC, 0x76, 0x66,
      0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00 },
    /* s (115) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0x60,
      0x38, 0x0C, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* t (116) */
    { 0x00, 0x00, 0x10, 0x30, 0x30, 0xFC, 0x30, 0x30,
      0x30, 0x30, 0x36, 0x1C, 0x00, 0x00, 0x00, 0x00 },
    /* u (117) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0xCC, 0xCC, 0xCC,
      0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 },
    /* v (118) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0xC3, 0xC3, 0xC3,
      0xC3, 0x66, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00 },
    /* w (119) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0xC6, 0xC6, 0xD6,
      0xD6, 0xD6, 0xFE, 0x6C, 0x00, 0x00, 0x00, 0x00 },
    /* x (120) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0xC6, 0x6C, 0x38,
      0x38, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00 },
    /* y (121) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0xC6, 0xC6, 0xC6,
      0xC6, 0xC6, 0xC6, 0x7E, 0x06, 0x0C, 0xF8, 0x00 },
    /* z (122) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xCC, 0x18,
      0x30, 0x60, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00 },
    /* { (123) */
    { 0x00, 0x00, 0x0E, 0x18, 0x18, 0x18, 0x70, 0x18,
      0x18, 0x18, 0x18, 0x0E, 0x00, 0x00, 0x00, 0x00 },
    /* | (124) */
    { 0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18,
      0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00 },
    /* } (125) */
    { 0x00, 0x00, 0x70, 0x18, 0x18, 0x18, 0x0E, 0x18,
      0x18, 0x18, 0x18, 0x70, 0x00, 0x00, 0x00, 0x00 },
    /* ~ (126) */
    { 0x00, 0x00, 0x76, 0xDC, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }
};

/**
 * Initialize framebuffer from boot information
 */
int fb_init(boot_info_t *boot_info) {
    kprintf("[FB] Initializing framebuffer driver...\n");

    if (boot_info == NULL) {
        kprintf("[FB] ERROR: Boot info is NULL\n");
        return -1;
    }

    if (!boot_info_valid(boot_info)) {
        kprintf("[FB] ERROR: Invalid boot info magic\n");
        return -2;
    }

    if (boot_info->framebuffer == 0) {
        kprintf("[FB] ERROR: No framebuffer address provided\n");
        return -3;
    }

    /* Populate framebuffer info */
    fb_info.address = (uint32_t *)boot_info->framebuffer;
    fb_info.width = boot_info->fb_width;
    fb_info.height = boot_info->fb_height;
    fb_info.pitch = boot_info->fb_pitch;
    fb_info.bpp = boot_info->fb_bpp;
    fb_info.size = fb_info.pitch * fb_info.height;
    fb_info.initialized = true;

    kprintf("[FB] Framebuffer initialized:\n");
    kprintf("[FB]   Address: 0x%016llx\n", (uint64_t)fb_info.address);
    kprintf("[FB]   Resolution: %ux%u\n", fb_info.width, fb_info.height);
    kprintf("[FB]   Pitch: %u bytes\n", fb_info.pitch);
    kprintf("[FB]   BPP: %u\n", fb_info.bpp);
    kprintf("[FB]   Size: %u bytes\n", fb_info.size);

    return 0;
}

/**
 * Get framebuffer information
 */
const framebuffer_t *fb_get_info(void) {
    return &fb_info;
}

/**
 * Check if framebuffer is initialized
 */
bool fb_is_initialized(void) {
    return fb_info.initialized;
}

/**
 * Helper: Calculate pixel offset in framebuffer
 */
static inline uint32_t *fb_pixel_addr(int x, int y) {
    /* pitch is in bytes, but we're using uint32_t pointers */
    return (uint32_t *)((uint8_t *)fb_info.address + y * fb_info.pitch + x * (fb_info.bpp / 8));
}

/**
 * Helper: Check if coordinates are within bounds
 */
static inline bool fb_in_bounds(int x, int y) {
    return x >= 0 && x < (int)fb_info.width &&
           y >= 0 && y < (int)fb_info.height;
}

/**
 * Draw a single pixel
 */
void fb_put_pixel(int x, int y, uint32_t color) {
    if (!fb_info.initialized) return;
    if (!fb_in_bounds(x, y)) return;

    *fb_pixel_addr(x, y) = color;
}

/**
 * Get pixel color at coordinates
 */
uint32_t fb_get_pixel(int x, int y) {
    if (!fb_info.initialized) return 0;
    if (!fb_in_bounds(x, y)) return 0;

    return *fb_pixel_addr(x, y);
}

/**
 * Draw a horizontal line (optimized)
 */
void fb_draw_hline(int x, int y, int w, uint32_t color) {
    if (!fb_info.initialized) return;
    if (y < 0 || y >= (int)fb_info.height) return;

    /* Clip to screen bounds */
    int x_start = (x < 0) ? 0 : x;
    int x_end = (x + w > (int)fb_info.width) ? (int)fb_info.width : x + w;

    if (x_start >= x_end) return;

    uint32_t *pixel = fb_pixel_addr(x_start, y);
    for (int i = x_start; i < x_end; i++) {
        *pixel++ = color;
    }
}

/**
 * Draw a vertical line (optimized)
 */
void fb_draw_vline(int x, int y, int h, uint32_t color) {
    if (!fb_info.initialized) return;
    if (x < 0 || x >= (int)fb_info.width) return;

    /* Clip to screen bounds */
    int y_start = (y < 0) ? 0 : y;
    int y_end = (y + h > (int)fb_info.height) ? (int)fb_info.height : y + h;

    if (y_start >= y_end) return;

    uint32_t *pixel = fb_pixel_addr(x, y_start);
    uint32_t pitch_pixels = fb_info.pitch / (fb_info.bpp / 8);

    for (int i = y_start; i < y_end; i++) {
        *pixel = color;
        pixel += pitch_pixels;
    }
}

/**
 * Fill a rectangle with solid color
 */
void fb_fill_rect(int x, int y, int w, int h, uint32_t color) {
    if (!fb_info.initialized) return;

    /* Clip to screen bounds */
    int x_start = (x < 0) ? 0 : x;
    int y_start = (y < 0) ? 0 : y;
    int x_end = (x + w > (int)fb_info.width) ? (int)fb_info.width : x + w;
    int y_end = (y + h > (int)fb_info.height) ? (int)fb_info.height : y + h;

    if (x_start >= x_end || y_start >= y_end) return;

    int row_width = x_end - x_start;
    uint32_t pitch_pixels = fb_info.pitch / (fb_info.bpp / 8);

    uint32_t *row_start = fb_pixel_addr(x_start, y_start);
    for (int row = y_start; row < y_end; row++) {
        uint32_t *pixel = row_start;
        for (int col = 0; col < row_width; col++) {
            *pixel++ = color;
        }
        row_start += pitch_pixels;
    }
}

/**
 * Draw a rectangle outline
 */
void fb_draw_rect(int x, int y, int w, int h, uint32_t color) {
    if (!fb_info.initialized) return;
    if (w <= 0 || h <= 0) return;

    /* Draw four lines */
    fb_draw_hline(x, y, w, color);           /* Top */
    fb_draw_hline(x, y + h - 1, w, color);   /* Bottom */
    fb_draw_vline(x, y, h, color);           /* Left */
    fb_draw_vline(x + w - 1, y, h, color);   /* Right */
}

/**
 * Draw a line using Bresenham's algorithm
 */
void fb_draw_line(int x0, int y0, int x1, int y1, uint32_t color) {
    if (!fb_info.initialized) return;

    /* Optimize for horizontal and vertical lines */
    if (y0 == y1) {
        if (x0 > x1) {
            int tmp = x0; x0 = x1; x1 = tmp;
        }
        fb_draw_hline(x0, y0, x1 - x0 + 1, color);
        return;
    }
    if (x0 == x1) {
        if (y0 > y1) {
            int tmp = y0; y0 = y1; y1 = tmp;
        }
        fb_draw_vline(x0, y0, y1 - y0 + 1, color);
        return;
    }

    /* Bresenham's line algorithm */
    int dx = (x1 > x0) ? (x1 - x0) : (x0 - x1);
    int dy = (y1 > y0) ? (y1 - y0) : (y0 - y1);
    int sx = (x0 < x1) ? 1 : -1;
    int sy = (y0 < y1) ? 1 : -1;
    int err = dx - dy;

    while (1) {
        fb_put_pixel(x0, y0, color);

        if (x0 == x1 && y0 == y1) break;

        int e2 = 2 * err;
        if (e2 > -dy) {
            err -= dy;
            x0 += sx;
        }
        if (e2 < dx) {
            err += dx;
            y0 += sy;
        }
    }
}

/**
 * Draw a character using 8x16 bitmap font
 */
void fb_draw_char(int x, int y, char c, uint32_t fg, uint32_t bg) {
    if (!fb_info.initialized) return;

    /* Only handle printable ASCII characters */
    if (c < 32 || c > 126) {
        c = '?';  /* Replace unprintable characters with '?' */
    }

    const uint8_t *glyph = font_8x16[c - 32];

    for (int row = 0; row < FB_FONT_HEIGHT; row++) {
        uint8_t bits = glyph[row];
        for (int col = 0; col < FB_FONT_WIDTH; col++) {
            /* Check if bit is set (MSB first) */
            if (bits & (0x80 >> col)) {
                fb_put_pixel(x + col, y + row, fg);
            } else {
                fb_put_pixel(x + col, y + row, bg);
            }
        }
    }
}

/**
 * Draw a string
 */
void fb_draw_string(int x, int y, const char *str, uint32_t fg, uint32_t bg) {
    if (!fb_info.initialized) return;
    if (str == NULL) return;

    int cur_x = x;
    int cur_y = y;

    while (*str) {
        if (*str == '\n') {
            cur_x = x;
            cur_y += FB_FONT_HEIGHT;
        } else if (*str == '\r') {
            cur_x = x;
        } else if (*str == '\t') {
            /* Tab = 4 spaces */
            cur_x += FB_FONT_WIDTH * 4;
        } else {
            fb_draw_char(cur_x, cur_y, *str, fg, bg);
            cur_x += FB_FONT_WIDTH;
        }

        /* Wrap to next line if needed */
        if (cur_x + FB_FONT_WIDTH > (int)fb_info.width) {
            cur_x = x;
            cur_y += FB_FONT_HEIGHT;
        }

        str++;
    }
}

/**
 * Clear the entire screen with a color
 */
void fb_clear(uint32_t color) {
    if (!fb_info.initialized) return;

    kprintf("[FB] Clearing screen with color 0x%08x\n", color);

    /* Fast fill using 32-bit writes */
    uint32_t *pixel = fb_info.address;
    uint32_t total_pixels = (fb_info.pitch / (fb_info.bpp / 8)) * fb_info.height;

    for (uint32_t i = 0; i < total_pixels; i++) {
        *pixel++ = color;
    }
}

/**
 * Scroll the screen up by specified number of lines
 */
void fb_scroll(int lines) {
    if (!fb_info.initialized) return;
    if (lines <= 0) return;
    if (lines >= (int)fb_info.height) {
        fb_clear(FB_COLOR_BLACK);
        return;
    }

    kprintf("[FB] Scrolling screen up by %d lines\n", lines);

    uint32_t pitch_pixels = fb_info.pitch / (fb_info.bpp / 8);
    uint32_t *dst = fb_info.address;
    uint32_t *src = fb_info.address + (lines * pitch_pixels);

    /* Copy rows up */
    uint32_t rows_to_copy = fb_info.height - lines;
    for (uint32_t row = 0; row < rows_to_copy; row++) {
        for (uint32_t col = 0; col < fb_info.width; col++) {
            dst[col] = src[col];
        }
        dst += pitch_pixels;
        src += pitch_pixels;
    }

    /* Clear the bottom lines */
    for (int row = 0; row < lines; row++) {
        for (uint32_t col = 0; col < fb_info.width; col++) {
            dst[col] = FB_COLOR_BLACK;
        }
        dst += pitch_pixels;
    }
}

/**
 * Draw a filled circle using midpoint circle algorithm
 */
void fb_fill_circle(int cx, int cy, int r, uint32_t color) {
    if (!fb_info.initialized) return;
    if (r <= 0) return;

    int x = 0;
    int y = r;
    int d = 3 - 2 * r;

    while (x <= y) {
        /* Fill horizontal lines from -x to +x at various y offsets */
        fb_draw_hline(cx - x, cy + y, 2 * x + 1, color);
        fb_draw_hline(cx - x, cy - y, 2 * x + 1, color);
        fb_draw_hline(cx - y, cy + x, 2 * y + 1, color);
        fb_draw_hline(cx - y, cy - x, 2 * y + 1, color);

        if (d < 0) {
            d += 4 * x + 6;
        } else {
            d += 4 * (x - y) + 10;
            y--;
        }
        x++;
    }
}

/**
 * Draw a circle outline using midpoint circle algorithm
 */
void fb_draw_circle(int cx, int cy, int r, uint32_t color) {
    if (!fb_info.initialized) return;
    if (r <= 0) {
        fb_put_pixel(cx, cy, color);
        return;
    }

    int x = 0;
    int y = r;
    int d = 3 - 2 * r;

    while (x <= y) {
        /* Draw 8 symmetric points */
        fb_put_pixel(cx + x, cy + y, color);
        fb_put_pixel(cx - x, cy + y, color);
        fb_put_pixel(cx + x, cy - y, color);
        fb_put_pixel(cx - x, cy - y, color);
        fb_put_pixel(cx + y, cy + x, color);
        fb_put_pixel(cx - y, cy + x, color);
        fb_put_pixel(cx + y, cy - x, color);
        fb_put_pixel(cx - y, cy - x, color);

        if (d < 0) {
            d += 4 * x + 6;
        } else {
            d += 4 * (x - y) + 10;
            y--;
        }
        x++;
    }
}
